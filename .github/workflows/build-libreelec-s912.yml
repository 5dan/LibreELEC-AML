name: Build LibreELEC 12.2 for S912 PCDN

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release标签（如v12.2-s912-202602）'
        required: true
        default: 'v12.2-s912-pcdn'
      release_name:
        description: 'Release名称'
        required: true
        default: 'LibreELEC 12.2 S912 PCDN 专用版'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout 源码
        uses: actions/checkout@v4
        with:
          repository: dtechsrv/LibreELEC-AML
          ref: 12.2

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: 清理系统空间
        run: |
          sudo rm -rf /opt/hostedtoolcache /usr/share/dotnet /root/.cache /root/.gradle
          sudo apt clean
          sudo apt autoremove -y
          df -h

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y git build-essential gawk wget diffstat unzip texinfo gcc-multilib \
            chrpath socat cpio python3 python3-pip python3-pexpect xz-utils debianutils \
            iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev xterm \
            u-boot-tools dtc ccache

      - name: 配置 ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 完全避免 HereDoc，逐行 echo 写入，YAML 解析零风险
      # ------------------------------------------------------------
      - name: 替换S912配置文件
        run: |
          # 备份原始配置
          cp projects/S912/options projects/S912/options.bak

          # 逐行写入，使用单引号防止变量被 shell 展开（保留给编译系统）
          echo '################################################################################' > projects/S912/options
          echo '# setup system defaults' >> projects/S912/options
          echo '################################################################################' >> projects/S912/options
          echo '  case $TARGET_ARCH in' >> projects/S912/options
          echo '  arm)' >> projects/S912/options
          echo '    TARGET_CPU="cortex-a53"' >> projects/S912/options
          echo '    TARGET_CPU_FLAGS="+crc"' >> projects/S912/options
          echo '    TARGET_FLOAT=hard' >> projects/S912/options
          echo '    TARGET_FPU="neon-fp-armv8"' >> projects/S912/options
          echo '    TARGET_FEATURES="32bit"' >> projects/S912/options
          echo '    TARGET_KERNEL_ARCH="arm"' >> projects/S912/options
          echo '    TARGET_PATCH_ARCH="aarch64"' >> projects/S912/options
          echo '    ;;' >> projects/S912/options
          echo '  esac' >> projects/S912/options
          echo 'BOOTLOADER="u-boot"' >> projects/S912/options
          echo 'UBOOT_VERSION="vendor"' >> projects/S912/options
          echo 'KERNEL_TARGET="Image.lzo"' >> projects/S912/options
          echo 'KERNEL_UBOOT_EXTRA_TARGET="gxm_q200_2g.dtb gxm_q201_1g.dtb gxm_q201_2g.dtb"' >> projects/S912/options
          echo 'BUILD_ANDROID_BOOTIMG="no"' >> projects/S912/options
          echo 'ANDROID_BOOTIMG_OPTIONS="--base 0x0 --kernel_offset 0x1080000"' >> projects/S912/options
          echo 'KERNEL_MAKE_EXTRACMD=""' >> projects/S912/options
          echo 'KERNEL_EXTRA_DEPENDS_TARGET=""' >> projects/S912/options
          echo 'LINUX="amlogic-3.14"' >> projects/S912/options
          echo 'KERNEL_NAME="kernel.img"' >> projects/S912/options
          echo '################################################################################' >> projects/S912/options
          echo '# setup build defaults' >> projects/S912/options
          echo '################################################################################' >> projects/S912/options
          echo 'PROJECT_CFLAGS=""' >> projects/S912/options
          echo 'SQUASHFS_COMPRESSION="lzo"' >> projects/S912/options
          echo '################################################################################' >> projects/S912/options
          echo '# setup project defaults' >> projects/S912/options
          echo '################################################################################' >> projects/S912/options
          echo 'ALSA_SUPPORT="yes"' >> projects/S912/options
          echo 'OPENGL="no"' >> projects/S912/options
          echo 'OPENGLES="opengl-meson-t82x"' >> projects/S912/options
          echo 'MESON_FAMILY="gxm"' >> projects/S912/options
          echo 'UVESAFB_SUPPORT="no"' >> projects/S912/options
          echo 'DISPLAYSERVER="no"' >> projects/S912/options
          echo 'WINDOWMANAGER="none"' >> projects/S912/options
          echo 'GRAPHIC_DRIVERS=""' >> projects/S912/options
          echo 'KODIPLAYER_DRIVER="libamcodec"' >> projects/S912/options
          echo 'INITRAMFS_MODULES="font softcursor bitblit fbcon dwc_otg"' >> projects/S912/options
          echo 'ADDITIONAL_DRIVERS="gpu-aml RTL8192CU RTL8192DU RTL8192EU RTL8192FU RTL8812AU \' >> projects/S912/options
          echo '                      RTL8821CU RTL8188EU-aml RTL8189ES-aml RTL8189FS-aml RTL8723BS-aml \' >> projects/S912/options
          echo '                      RTL8723DS-aml RTL8822BU-aml"' >> projects/S912/options
          echo 'FIRMWARE="misc-firmware wlan-firmware dvb-firmware"' >> projects/S912/options
          echo 'ATVCLIENT_SUPPORT="no"' >> projects/S912/options
          echo 'AMREMOTE_SUPPORT="yes"' >> projects/S912/options
          echo 'ISCSI_SUPPORT="no"' >> projects/S912/options
          echo 'INSTALLER_SUPPORT="no"' >> projects/S912/options
          echo 'DRIVER_ADDONS_SUPPORT="yes"' >> projects/S912/options
          echo 'DRIVER_ADDONS="crazycat_aml dvb-latest"' >> projects/S912/options
          echo 'ADDITIONAL_PACKAGES="u-boot-tools-aml dtc"' >> projects/S912/options
          echo 'ADDON_VERSION="12.2"' >> projects/S912/options
          echo 'ADDON_SERVER_URL="https://libreelec.dtech.hu/packages"' >> projects/S912/options
          echo 'ADDON_PATH="$ADDON_VERSION/$PROJECT/$TARGET_ARCH"' >> projects/S912/options
          echo 'ADDON_URL="$ADDON_SERVER_URL/$ADDON_PATH"' >> projects/S912/options

      - name: 编译S912版LibreELEC 12.2
        run: |
          set -euo pipefail
          PROJECT=Amlogic DEVICE=S912 ARCH=arm make image -j$(nproc)

      - name: 打包镜像
        run: |
          set -euo pipefail
          cd target
          IMG_FILE=$(ls LibreELEC-*.img | head -1)
          if [ -z "$IMG_FILE" ]; then
            echo "错误：未找到镜像文件！" >&2
            exit 1
          fi
          mv -v "$IMG_FILE" librelec-12.2-s912-pcdn.img
          gzip -9 librelec-12.2-s912-pcdn.img
          sha256sum librelec-12.2-s912-pcdn.img.gz > librelec-12.2-s912-pcdn.img.gz.sha256

      - name: 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LibreELEC-12.2-S912-PCDN
          path: |
            target/librelec-12.2-s912-pcdn.img.gz
            target/librelec-12.2-s912-pcdn.img.gz.sha256

      - name: 获取编译时间
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: 创建并上传Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name }}
          files: |
            target/librelec-12.2-s912-pcdn.img.gz
            target/librelec-12.2-s912-pcdn.img.gz.sha256
          body: |
            ## LibreELEC 12.2 S912 PCDN盒子专用版
            - 适配S912芯片（GXM家族）
            - 内核：amlogic-3.14（稳定版）
            - 内置PCDN常用无线网卡驱动（RTL8192/8812/8821等）
            - 支持1G/2G内存盒子
            - ADDON_VERSION 已修复，插件源可用
            - 编译时间：${{ steps.date.outputs.date }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
